<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alphabet Countdown Chaos - 2 Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Added neon glow effects for red and blue players */
        @keyframes pulse-red {
            0%, 100% { 
                background-color: rgb(220, 38, 38);
                box-shadow: 0 0 30px rgba(255, 0, 64, 0.5);
            }
            50% { 
                background-color: rgb(185, 28, 28);
                box-shadow: 0 0 50px rgba(255, 0, 64, 0.8);
            }
        }
        @keyframes pulse-blue {
            0%, 100% { 
                background-color: rgb(37, 99, 235);
                box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            }
            50% { 
                background-color: rgb(29, 78, 216);
                box-shadow: 0 0 50px rgba(0, 212, 255, 0.8);
            }
        }
        .pulse-red-bg {
            animation: pulse-red 1s ease-in-out infinite;
        }
        .pulse-blue-bg {
            animation: pulse-blue 1s ease-in-out infinite;
        }
        .neon-red {
            box-shadow: 0 0 10px rgba(255, 0, 64, 0.5), 0 0 20px rgba(255, 0, 64, 0.3);
        }
        .neon-blue {
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5), 0 0 20px rgba(0, 212, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const LETTER_VALUES = {
            E: 1, T: 1, A: 1, O: 1, N: 1,
            R: 2, I: 2, S: 2, H: 2, D: 2,
            L: 3, F: 3, C: 3, M: 3, U: 3,
            G: 4, Y: 4, P: 4, W: 4, B: 4,
            V: 5, K: 5, J: 5, X: 5, Z: 5, Q: 5
        };

        let gameState = 'menu'; // menu, playing, paused, gameover, challenge
        let selectedTime = 20;
        let bannedLetters = new Set();
        let availableLetters = [];
        let currentPlayer = 'red'; // 'red' or 'blue'
        let lastPlayer = null; // Track who clicked the last letter
        let redUsedLetters = new Set();
        let blueUsedLetters = new Set();
        let redScore = 0;
        let blueScore = 0;
        let timeLeft = 20;
        let maxTime = 20;
        let timerInterval = null;
        let audioInitialized = false;
        let manualEnd = false; // Track if game ended manually

        // Initialize audio context
        function initAudio() {
            if (!audioInitialized && typeof Tone !== 'undefined') {
                audioInitialized = true;
            }
        }

        // Play sound effects
        function playSound(type) {
            if (typeof Tone === 'undefined') return;
            
            try {
                const oscillatorType = {
                    'click': 'sine',
                    'win': 'sawtooth',
                    'lose': 'triangle',
                    'tick': 'square'
                }[type];

                const synth = new Tone.Synth({
                    oscillator: { type: oscillatorType }
                }).toDestination();

                const note = {
                    'click': 'C5',
                    'win': 'C6',
                    'lose': 'C3',
                    'tick': 'C4'
                }[type];

                const duration = type === 'tick' ? '32n' : '8n';
                synth.triggerAttackRelease(note, duration);
            } catch (e) {
                console.error('Audio error:', e);
            }
        }

        function startGame() {
            initAudio();
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').filter(letter => !bannedLetters.has(letter));
            availableLetters = alphabet;
            redUsedLetters = new Set();
            blueUsedLetters = new Set();
            redScore = 0;
            blueScore = 0;
            currentPlayer = 'red';
            lastPlayer = null; // Reset last player
            timeLeft = selectedTime;
            maxTime = selectedTime;
            gameState = 'playing';
            manualEnd = false; // Reset manual end flag
            render();
            startTimer();
        }

        // Toggle banned letter
        function toggleBannedLetter(letter) {
            if (bannedLetters.has(letter)) {
                bannedLetters.delete(letter);
            } else {
                bannedLetters.add(letter);
            }
            render();
        }

        function handleLetterClick(letter) {
            if (gameState !== 'playing') return;
            
            const currentUsedLetters = currentPlayer === 'red' ? redUsedLetters : blueUsedLetters;
            if (currentUsedLetters.has(letter)) return;
            if (!availableLetters.includes(letter)) return;

            initAudio();
            playSound('click');

            const letterValue = LETTER_VALUES[letter];
            const timeBonus = Math.floor(timeLeft);
            const points = letterValue * timeBonus;

            currentUsedLetters.add(letter);
            if (currentPlayer === 'red') {
                redScore += points;
            } else {
                blueScore += points;
            }

            lastPlayer = currentPlayer; // Track who clicked this letter

            const totalUsedLetters = new Set([...redUsedLetters, ...blueUsedLetters]);
            if (totalUsedLetters.size === availableLetters.length) {
                gameState = 'gameover';
                playSound('win');
                stopTimer();
                render();
                return;
            }

            // Switch player and reset timer
            currentPlayer = currentPlayer === 'red' ? 'blue' : 'red';
            timeLeft = selectedTime;
            render();
        }

        // Timer functions
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 5) {
                    playSound('tick');
                }
                if (timeLeft <= 0) {
                    // Current player loses their turn, switch to other player
                    playSound('lose');
                    currentPlayer = currentPlayer === 'red' ? 'blue' : 'red';
                    timeLeft = selectedTime;
                }
                render();
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (gameState === 'playing') {
                const letter = e.key.toUpperCase();
                if (letter.match(/^[A-Z]$/)) {
                    handleLetterClick(letter);
                } else if (e.key === ' ') {
                    e.preventDefault();
                    gameState = 'paused';
                    stopTimer();
                    render();
                }
            } else if (gameState === 'paused' && e.key === ' ') {
                e.preventDefault();
                gameState = 'playing';
                startTimer();
                render();
            }
        });

        function openChallenge() {
            gameState = 'challenge';
            stopTimer();
            render();
        }

        function handleChallengeCorrect() {
            // Current player (who clicked ARE YOU SURE?) loses 10% rounded up
            const penalty = Math.ceil((currentPlayer === 'red' ? redScore : blueScore) * 0.1);
            if (currentPlayer === 'red') {
                redScore = Math.max(0, redScore - penalty);
            } else {
                blueScore = Math.max(0, blueScore - penalty);
            }
            gameState = 'playing';
            startTimer();
            render();
        }

        function handleChallengeIncorrect() {
            // Last player (who clicked the last letter) loses 10% rounded up
            if (lastPlayer) {
                const penalty = Math.ceil((lastPlayer === 'red' ? redScore : blueScore) * 0.1);
                if (lastPlayer === 'red') {
                    redScore = Math.max(0, redScore - penalty);
                } else {
                    blueScore = Math.max(0, blueScore - penalty);
                }
            }
            gameState = 'playing';
            startTimer();
            render();
        }

        function endGame() {
            manualEnd = true; // Mark as manual end
            gameState = 'gameover';
            playSound('win');
            stopTimer();
            render();
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            
            if (gameState === 'menu') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-red-600 via-purple-600 to-blue-600 flex items-center justify-center p-4">
                        <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 max-w-2xl w-full border-4 border-purple-500">
                            <h1 class="text-4xl font-bold text-center mb-2 bg-gradient-to-r from-red-400 to-blue-400 bg-clip-text text-transparent">Alphabet Countdown Chaos</h1>
                            <p class="text-center text-gray-300 mb-6">Red vs Blue - Click all letters before time runs out!</p>

                            <div class="mb-8">
                                <h2 class="text-xl font-semibold mb-4 text-white">Select Time Per Letter</h2>
                                <div class="flex gap-4 justify-center">
                                    ${[10, 20, 30].map(time => `
                                        <button onclick="selectedTime = ${time}; render();" 
                                            class="text-lg px-8 py-6 rounded-lg font-semibold transition-all ${
                                                selectedTime === time 
                                                    ? 'bg-purple-600 text-white neon-red' 
                                                    : 'bg-gray-800 border-2 border-gray-600 text-gray-300 hover:border-purple-500'
                                            }">
                                            ${time}s
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="mb-8">
                                <h2 class="text-xl font-semibold mb-4 text-white">Ban Letters (Click to toggle)</h2>
                                <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-3">
                                    ${'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(letter => `
                                        <button onclick="toggleBannedLetter('${letter}')"
                                            class="aspect-square rounded-xl font-bold text-2xl transition-all transform hover:scale-105 active:scale-95 shadow-lg relative ${
                                                bannedLetters.has(letter)
                                                    ? 'bg-red-600 text-white line-through neon-red'
                                                    : 'bg-gray-800 hover:bg-gray-700 text-gray-200 border-2 border-gray-600'
                                            }">
                                            ${letter}
                                            <span class="absolute bottom-1 right-1 text-xs opacity-60">${LETTER_VALUES[letter]}</span>
                                        </button>
                                    `).join('')}
                                </div>
                                <p class="text-sm text-gray-400 mt-2 text-center">
                                    ${bannedLetters.size > 0 
                                        ? `${bannedLetters.size} letter${bannedLetters.size > 1 ? 's' : ''} banned`
                                        : 'No letters banned'}
                                </p>
                            </div>

                            <button onclick="startGame()" 
                                ${bannedLetters.size === 26 ? 'disabled' : ''}
                                class="w-full text-xl py-6 rounded-lg font-semibold bg-gradient-to-r from-red-600 to-blue-600 hover:from-red-700 hover:to-blue-700 text-white transition-all neon-red ${
                                    bannedLetters.size === 26 ? 'opacity-50 cursor-not-allowed' : ''
                                }">
                                Start Game
                            </button>
                        </div>
                    </div>
                `;
            } else if (gameState === 'gameover') {
                const winner = redScore > blueScore ? 'red' : blueScore > redScore ? 'blue' : 'tie';
                const winnerColor = winner === 'red' ? 'text-red-400' : winner === 'blue' ? 'text-blue-400' : 'text-purple-400';
                const winnerBg = winner === 'red' ? 'from-red-600 to-red-800' : winner === 'blue' ? 'from-blue-600 to-blue-800' : 'from-purple-600 to-purple-800';
                
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br ${winnerBg} flex items-center justify-center p-4">
                        <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-4 ${winner === 'red' ? 'border-red-500 neon-red' : winner === 'blue' ? 'border-blue-500 neon-blue' : 'border-purple-500'}">
                            <h1 class="text-5xl font-bold mb-4 ${winnerColor}">
                                ${winner === 'tie' ? '🤝 Tie Game!' : winner === 'red' ? '🔴 Red Wins!' : '🔵 Blue Wins!'}
                            </h1>
                            <div class="mb-6 space-y-3">
                                <div class="bg-red-900/50 rounded-lg p-4 border-2 border-red-500">
                                    <p class="text-red-400 font-semibold">Red Player</p>
                                    <p class="text-3xl font-bold text-white">${redScore}</p>
                                    <p class="text-sm text-gray-400">${redUsedLetters.size} / ${availableLetters.length} letters</p>
                                </div>
                                <div class="bg-blue-900/50 rounded-lg p-4 border-2 border-blue-500">
                                    <p class="text-blue-400 font-semibold">Blue Player</p>
                                    <p class="text-3xl font-bold text-white">${blueScore}</p>
                                    <p class="text-sm text-gray-400">${blueUsedLetters.size} / ${availableLetters.length} letters</p>
                                </div>
                            </div>
                            
                            ${manualEnd ? `
                                <div class="mb-6">
                                    <h2 class="text-xl font-semibold mb-4 text-white">Letters Used</h2>
                                    <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2">
                                        ${availableLetters.map(letter => {
                                            const usedByRed = redUsedLetters.has(letter);
                                            const usedByBlue = blueUsedLetters.has(letter);
                                            
                                            let buttonClass = '';
                                            if (usedByRed && usedByBlue) {
                                                buttonClass = 'bg-purple-600 text-white border-2 border-purple-400';
                                            } else if (usedByRed) {
                                                buttonClass = 'bg-red-600 text-white border-2 border-red-400 neon-red';
                                            } else if (usedByBlue) {
                                                buttonClass = 'bg-blue-600 text-white border-2 border-blue-400 neon-blue';
                                            } else {
                                                buttonClass = 'bg-gray-700 text-gray-400 border-2 border-gray-600';
                                            }
                                            
                                            return `
                                                <div class="aspect-square rounded-lg font-bold text-xl flex items-center justify-center shadow-lg relative ${buttonClass}">
                                                    ${letter}
                                                    <span class="absolute bottom-0.5 right-0.5 text-xs opacity-60">${LETTER_VALUES[letter]}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    <p class="text-sm text-gray-400 mt-3">
                                        <span class="text-red-400">■</span> Red used
                                        <span class="ml-3 text-blue-400">■</span> Blue used
                                        <span class="ml-3 text-purple-400">■</span> Both used
                                        <span class="ml-3 text-gray-400">■</span> Unused
                                    </p>
                                </div>
                            ` : ''}
                            
                            <div class="flex gap-4">
                                <button onclick="gameState = 'menu'; render();" 
                                    class="flex-1 px-6 py-3 rounded-lg font-semibold bg-gray-800 border-2 border-gray-600 text-gray-300 hover:border-purple-500 transition-all">
                                    Main Menu
                                </button>
                                <button onclick="startGame();" 
                                    class="flex-1 px-6 py-3 rounded-lg font-semibold bg-purple-600 text-white hover:bg-purple-700 transition-all neon-red">
                                    Play Again
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (gameState === 'paused') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-red-600 via-purple-600 to-blue-600 flex items-center justify-center p-4">
                        <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-4 border-purple-500">
                            <h1 class="text-4xl font-bold mb-4 text-white">⏸️ Paused</h1>
                            <div class="mb-6 space-y-3">
                                <div class="bg-red-900/50 rounded-lg p-3 border-2 border-red-500">
                                    <p class="text-red-400 font-semibold">Red: ${redScore}</p>
                                </div>
                                <div class="bg-blue-900/50 rounded-lg p-3 border-2 border-blue-500">
                                    <p class="text-blue-400 font-semibold">Blue: ${blueScore}</p>
                                </div>
                            </div>
                            <button onclick="gameState = 'playing'; startTimer(); render();" 
                                class="w-full px-6 py-3 rounded-lg font-semibold bg-purple-600 text-white hover:bg-purple-700 transition-all neon-red">
                                Resume
                            </button>
                        </div>
                    </div>
                `;
            } else if (gameState === 'challenge') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-yellow-600 via-orange-600 to-red-600 flex items-center justify-center p-4">
                        <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-4 border-yellow-500">
                            <h1 class="text-4xl font-bold mb-4 text-yellow-400">⚠️ Challenge!</h1>
                            <p class="text-white text-lg mb-6">
                                Was "${lastPlayer === 'red' ? '🔴 Red' : '🔵 Blue'}" player's last word valid?
                            </p>
                            <div class="mb-6 space-y-3">
                                <div class="bg-red-900/50 rounded-lg p-3 border-2 border-red-500">
                                    <p class="text-red-400 font-semibold">Red: ${redScore}</p>
                                </div>
                                <div class="bg-blue-900/50 rounded-lg p-3 border-2 border-blue-500">
                                    <p class="text-blue-400 font-semibold">Blue: ${blueScore}</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-400 mb-6">
                                Penalty: 10% of score (rounded up)
                            </p>
                            <div class="space-y-3">
                                <button onclick="handleChallengeCorrect();" 
                                    class="w-full px-6 py-4 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 transition-all text-lg">
                                    ✓ CORRECT
                                    <span class="block text-sm opacity-80">Challenger loses points</span>
                                </button>
                                <button onclick="handleChallengeIncorrect();" 
                                    class="w-full px-6 py-4 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-700 transition-all text-lg">
                                    ✗ INCORRECT
                                    <span class="block text-sm opacity-80">Last player loses points</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (gameState === 'playing') {
                const progressPercent = (timeLeft / maxTime) * 100;
                const progressColor = progressPercent > 50 ? 'bg-green-500' : progressPercent > 25 ? 'bg-yellow-500' : 'bg-red-500';
                const bgClass = currentPlayer === 'red' 
                    ? (timeLeft <= 5 ? 'pulse-red-bg' : 'bg-gradient-to-br from-red-600 to-red-800')
                    : (timeLeft <= 5 ? 'pulse-blue-bg' : 'bg-gradient-to-br from-blue-600 to-blue-800');
                const playerColor = currentPlayer === 'red' ? 'text-red-400' : 'text-blue-400';
                const playerBorder = currentPlayer === 'red' ? 'border-red-500' : 'border-blue-500';
                const playerNeon = currentPlayer === 'red' ? 'neon-red' : 'neon-blue';
                
                app.innerHTML = `
                    <div class="min-h-screen transition-colors duration-500 ${bgClass}">
                        <div class="container mx-auto p-4 max-w-4xl">
                            <div class="bg-gray-900 rounded-2xl shadow-2xl p-6 mb-6 border-4 ${playerBorder} ${playerNeon}">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h1 class="text-3xl font-bold ${playerColor}">
                                            ${currentPlayer === 'red' ? '🔴 Red Player' : '🔵 Blue Player'}
                                        </h1>
                                        <p class="text-gray-400">
                                            Remaining: <span class="font-bold ${playerColor} text-2xl">
                                                ${availableLetters.length - (currentPlayer === 'red' ? redUsedLetters.size : blueUsedLetters.size)}
                                            </span>
                                            <span class="text-sm ml-2 text-gray-500">
                                                / ${availableLetters.length} letters
                                            </span>
                                        </p>
                                    </div>
                                    <div class="text-right space-y-2">
                                        <div class="bg-red-900/50 rounded-lg px-4 py-2 border-2 border-red-500">
                                            <p class="text-red-400 text-sm">Red</p>
                                            <p class="text-2xl font-bold text-white">${redScore}</p>
                                        </div>
                                        <div class="bg-blue-900/50 rounded-lg px-4 py-2 border-2 border-blue-500">
                                            <p class="text-blue-400 text-sm">Blue</p>
                                            <p class="text-2xl font-bold text-white">${blueScore}</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="w-full bg-gray-700 rounded-full h-4 mb-4 overflow-hidden">
                                    <div class="h-full transition-all duration-1000 ${progressColor}" 
                                        style="width: ${progressPercent}%"></div>
                                </div>

                                <div class="flex justify-between items-center">
                                    <p class="text-2xl font-bold text-white">⏱️ ${timeLeft}s</p>
                                    <div class="flex gap-3">
                                        ${lastPlayer ? `
                                            <button onclick="openChallenge();" 
                                                class="px-6 py-2 rounded-lg font-semibold bg-yellow-600 border-2 border-yellow-500 text-white hover:bg-yellow-500 transition-all">
                                                ARE YOU SURE?
                                            </button>
                                        ` : ''}
                                        <button onclick="endGame();" 
                                            class="px-6 py-2 rounded-lg font-semibold bg-red-700 border-2 border-red-500 text-white hover:bg-red-600 transition-all neon-red">
                                            END GAME
                                        </button>
                                        <button onclick="gameState = 'paused'; stopTimer(); render();" 
                                            class="px-6 py-2 rounded-lg font-semibold bg-gray-800 border-2 border-gray-600 text-gray-300 hover:border-purple-500 transition-all">
                                            Pause
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-3">
                                ${availableLetters.map(letter => {
                                    const usedByRed = redUsedLetters.has(letter);
                                    const usedByBlue = blueUsedLetters.has(letter);
                                    const usedByCurrent = currentPlayer === 'red' ? usedByRed : usedByBlue;
                                    
                                    let buttonClass = '';
                                    if (usedByRed && usedByBlue) {
                                        buttonClass = 'bg-purple-600 text-white cursor-not-allowed border-2 border-purple-400';
                                    } else if (usedByRed) {
                                        buttonClass = 'bg-red-600 text-white cursor-not-allowed border-2 border-red-400 neon-red';
                                    } else if (usedByBlue) {
                                        buttonClass = 'bg-blue-600 text-white cursor-not-allowed border-2 border-blue-400 neon-blue';
                                    } else {
                                        buttonClass = `bg-gray-800 text-gray-200 hover:bg-gray-700 border-2 ${currentPlayer === 'red' ? 'border-red-500 hover:border-red-400' : 'border-blue-500 hover:border-blue-400'}`;
                                    }
                                    
                                    return `
                                        <button onclick="handleLetterClick('${letter}')"
                                            ${usedByCurrent ? 'disabled' : ''}
                                            class="aspect-square rounded-xl font-bold text-2xl transition-all transform hover:scale-105 active:scale-95 shadow-lg relative ${buttonClass}"
                                            aria-label="Letter ${letter}">
                                            ${letter}
                                            <span class="absolute bottom-1 right-1 text-xs opacity-60">${LETTER_VALUES[letter]}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>

                            <div class="mt-6 bg-gray-900 rounded-2xl shadow-2xl p-4 text-center border-2 ${playerBorder}">
                                <p class="text-gray-300">Click or type any letter before time runs out!</p>
                                <p class="text-sm text-gray-500 mt-2">Score = Letter Value × Time Remaining</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Initial render
        render();
    </script>
</body>
</html>
