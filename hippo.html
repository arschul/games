<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pool Party Hippo Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --pool-size: 120px;
      --water-blue: #0ea5e9;
      --deep-water: #0284c7;
      --pool-tile: #06b6d4;
      --pool-edge: #0891b2;
      --sun-yellow: #fbbf24;
      --coral: #f97316;
      --palm-green: #22c55e;
      --sand: #fef3c7;
      --player1-float: #ef4444;
      --player2-float: #8b5cf6;
      --splash-white: rgba(255, 255, 255, 0.8);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.8s ease;
      user-select: none;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(251, 191, 36, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(34, 197, 94, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.1) 0%, transparent 30%);
      pointer-events: none;
      z-index: 0;
    }

    body.player1-turn {
      background: linear-gradient(135deg, #fecaca 0%, #f87171 30%, #0ea5e9 70%, #0284c7 100%);
    }

    body.player2-turn {
      background: linear-gradient(135deg, #ddd6fe 0%, #a78bfa 30%, #0ea5e9 70%, #0284c7 100%);
    }

    h1 {
      color: white;
      margin-bottom: 10px;
      font-size: 2.5rem;
      font-weight: 800;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      z-index: 1;
      position: relative;
    }

    .pool-deck {
      background: linear-gradient(45deg, #f3f4f6, #e5e7eb);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 
        0 20px 40px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.5);
      position: relative;
      z-index: 1;
      margin-bottom: 20px;
    }

    #game-board {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      overflow-x: auto;
      padding: 10px;
      min-height: 150px;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .pool {
      position: relative;
      width: var(--pool-size);
      height: var(--pool-size);
      background: 
        radial-gradient(circle at 30% 30%, var(--water-blue), var(--deep-water));
      border-radius: 20px;
      border: 4px solid var(--pool-edge);
      box-shadow: 
        0 8px 20px rgba(0,0,0,0.3),
        inset 0 2px 10px rgba(255,255,255,0.2),
        inset 0 -2px 10px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 15px 10px 10px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      overflow: visible;
    }

    /* Pool capacity indicators */
    .pool[data-pool="1"], .pool[data-pool="2"], .pool[data-pool="3"], 
    .pool[data-pool="4"], .pool[data-pool="5"], .pool[data-pool="6"] {
      background: 
        linear-gradient(to bottom, 
          rgba(14, 165, 233, 0.8) 0%, 
          rgba(6, 182, 212, 0.8) 50%, 
          rgba(2, 132, 199, 0.8) 100%),
        radial-gradient(circle at 30% 30%, var(--water-blue), var(--deep-water));
    }

    .pool[data-pool="8"], .pool[data-pool="9"], .pool[data-pool="10"], 
    .pool[data-pool="11"], .pool[data-pool="12"] {
      background: 
        linear-gradient(to bottom, 
          rgba(14, 165, 233, 0.8) 0%, 
          rgba(2, 132, 199, 0.8) 100%),
        radial-gradient(circle at 30% 30%, var(--water-blue), var(--deep-water));
    }

    /* Pool 7 keeps its special appearance */
    .pool[data-pool="7"] {
      background: 
        radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
    }

    .pool::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      height: 20px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.3) 20%, 
        rgba(255,255,255,0.6) 50%, 
        rgba(255,255,255,0.3) 80%, 
        transparent 100%);
      border-radius: 10px;
      pointer-events: none;
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }

    .pool:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 12px 25px rgba(0,0,0,0.4),
        inset 0 2px 10px rgba(255,255,255,0.3);
    }

    /* Pool capacity divider lines */
    .pool[data-pool="1"]::after, .pool[data-pool="2"]::after, .pool[data-pool="3"]::after,
    .pool[data-pool="4"]::after, .pool[data-pool="5"]::after, .pool[data-pool="6"]::after {
      content: '';
      position: absolute;
      left: 15px;
      right: 15px;
      height: 2px;
      background: rgba(255, 255, 255, 0.7);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 5;
      top: calc(33.33% + 15px);
    }

    /* Second divider line for pools 1-6 using ::before */
    .pool[data-pool="1"]::before, .pool[data-pool="2"]::before, .pool[data-pool="3"]::before,
    .pool[data-pool="4"]::before, .pool[data-pool="5"]::before, .pool[data-pool="6"]::before {
      content: '';
      position: absolute;
      left: 15px;
      right: 15px;
      height: 2px;
      background: rgba(255, 255, 255, 0.7);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 5;
      top: calc(66.66% + 15px);
    }

    /* One centered divider line for pools 8-12 */
    .pool[data-pool="8"]::after, .pool[data-pool="9"]::after, .pool[data-pool="10"]::after,
    .pool[data-pool="11"]::after, .pool[data-pool="12"]::after {
      content: '';
      position: absolute;
      left: 15px;
      right: 15px;
      height: 2px;
      background: rgba(255, 255, 255, 0.7);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 5;
      top: calc(50% + 7px);
    }

    /* Override the shimmer effect for pools 1-6 since we're using ::before for dividers */
    .pool[data-pool="1"]::before, .pool[data-pool="2"]::before, .pool[data-pool="3"]::before,
    .pool[data-pool="4"]::before, .pool[data-pool="5"]::before, .pool[data-pool="6"]::before {
      animation: none;
      background: rgba(255, 255, 255, 0.7);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      height: 2px;
      top: calc(66.66% + 15px);
      border-radius: 0;
    }

    /* Keep shimmer effect for pools 7-12 */
    .pool[data-pool="7"]::before,
    .pool[data-pool="8"]::before, .pool[data-pool="9"]::before, .pool[data-pool="10"]::before,
    .pool[data-pool="11"]::before, .pool[data-pool="12"]::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      height: 20px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.3) 20%, 
        rgba(255,255,255,0.6) 50%, 
        rgba(255,255,255,0.3) 80%, 
        transparent 100%);
      border-radius: 10px;
      pointer-events: none;
      animation: shimmer 3s ease-in-out infinite;
    }

    /* No divider lines for pool 7 */
    .pool[data-pool="7"]::after {
      display: none;
    }

    .highlight-red {
      background: 
        radial-gradient(circle at 30% 30%, #fca5a5, #ef4444);
      border-color: var(--player1-float);
      animation: ripple-red 1s ease-in-out infinite;
    }

    .highlight-blue {
      background: 
        radial-gradient(circle at 30% 30%, #c4b5fd, #8b5cf6);
      border-color: var(--player2-float);
      animation: ripple-blue 1s ease-in-out infinite;
    }

    @keyframes ripple-red {
      0%, 100% { box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 0 10px rgba(239, 68, 68, 0); }
    }

    @keyframes ripple-blue {
      0%, 100% { box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 0 0 rgba(139, 92, 246, 0.7); }
      50% { box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 0 10px rgba(139, 92, 246, 0); }
    }

    .pool-number {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--sun-yellow), var(--coral));
      border-radius: 50%;
      font-size: 1rem;
      font-weight: 800;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      pointer-events: none;
      user-select: none;
      z-index: 10;
    }

    .pool-number.special {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      animation: pulse-special 2s ease-in-out infinite;
    }

    @keyframes pulse-special {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.1); }
    }

    .token-stack {
      margin-top: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 6px;
      min-height: 30px;
      overflow: visible;
      align-items: center;
    }

    .token {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
      border: 3px solid rgba(255,255,255,0.8);
      box-shadow: 
        0 4px 8px rgba(0,0,0,0.3),
        inset 0 2px 4px rgba(255,255,255,0.5);
      position: relative;
    }

    .token::before {
      content: '🦛';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.5));
    }

    .controls-deck {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
      max-width: 600px;
      width: 100%;
    }

    #controls {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    #dice-container {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .die {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      border-radius: 15px;
      border: 3px solid #e2e8f0;
      box-shadow: 
        0 6px 12px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.8);
      font-size: 1.8rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      color: #334155;
    }

    .die:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .die.selected {
      background: linear-gradient(135deg, var(--pool-tile), var(--water-blue));
      color: white;
      border-color: var(--deep-water);
      transform: translateY(-2px) scale(1.05);
    }

    button {
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--water-blue), var(--deep-water));
      color: white;
      margin: 5px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      user-select: none;
      min-width: 100px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    button:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--deep-water), #0369a1);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }

    button:disabled {
      background: linear-gradient(135deg, #94a3b8, #64748b);
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    #player-status {
      margin-top: 15px;
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      justify-content: center;
      gap: 30px;
      width: 100%;
      flex-wrap: wrap;
    }

    .player-name {
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      padding: 10px 15px;
      border-radius: 12px;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .player-name.active {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      animation: glow-pulse 2s ease-in-out infinite;
    }

    @keyframes glow-pulse {
      0%, 100% { 
        box-shadow: 0 8px 16px rgba(0,0,0,0.3), 0 0 0 0 rgba(251, 191, 36, 0.7); 
      }
      50% { 
        box-shadow: 0 8px 16px rgba(0,0,0,0.3), 0 0 0 8px rgba(251, 191, 36, 0); 
      }
    }

    .stars {
      font-size: 1.4rem;
      user-select: none;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
    }

    #token-tracker {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 15px;
      gap: 20px;
    }

    .token-info {
      font-weight: 700;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      background: rgba(255,255,255,0.9);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .token-left {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-top: 8px;
    }

    .token-count {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
      border: 2px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      position: relative;
    }

    .token-count::before {
      content: '🦛';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
    }

    #flying-token {
      position: absolute;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.8);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      pointer-events: none;
      transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), 
                  left 0.8s cubic-bezier(0.4, 0, 0.2, 1), 
                  top 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
    }

    #flying-token::before {
      content: '🦛';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.5));
    }

    @media (max-width: 768px) {
      :root {
        --pool-size: 100px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      #game-board {
        gap: 10px;
      }
      
      .die {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }
      
      #player-status {
        font-size: 1.1rem;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <h1>🏊‍♀️ Pool Party Hippo Game 🦛</h1>
  
  <div class="pool-deck">
    <div id="game-board"></div>
  </div>
  
  <div class="controls-deck">
    <div id="controls">
      <div id="dice-container"></div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <button onclick="confirmChoice()" id="doneBtn" disabled>🎯 Done</button>
        <button onclick="rollDice()" id="rollBtn">🎲 Roll Dice</button>
        <button onclick="newGame()">🔄 New Game</button>
      </div>
      <div id="player-status"></div>
      <div id="token-tracker"></div>
    </div>
  </div>

  <script>
    const players = [
      { name: '🏊‍♂️ Player 1', color: '#ef4444', tokens: 8, wins: 0 },
      { name: '🏊‍♀️ Player 2', color: '#8b5cf6', tokens: 8, wins: 0 }
    ];

    let currentPlayerIndex = 0;
    let dice = [];
    let selectedDice = [];
    let availableMoves = [];
    let isAnimating = false;
    let lastStarterIndex = 1;

    const pools = Array.from({ length: 12 }, (_, i) => ({
      number: i + 1,
      tokens: []
    }));

    function getMaxTokens(poolNumber) {
      if (poolNumber === 7) return 3; // Pool 7 stays at 3
      if (poolNumber >= 8 && poolNumber <= 12) return 2; // Pools 8-12 now max 2
      return 3; // Pools 1-6 stay at 3
    }

    function updateBackground() {
      document.body.className = currentPlayerIndex === 0 ? 'player1-turn' : 'player2-turn';
    }

    function renderBoard() {
      updateBackground();
      const board = document.getElementById('game-board');
      board.innerHTML = '';

      pools.forEach(pool => {
        const div = document.createElement('div');
        div.className = 'pool';
        div.dataset.pool = pool.number;
        
        if (availableMoves.includes(pool.number)) {
          div.classList.add(currentPlayerIndex === 0 ? 'highlight-red' : 'highlight-blue');
        }

        div.onclick = () => {
          if (availableMoves.includes(pool.number) && !isAnimating) handlePlacement(pool);
        };

        const number = document.createElement('div');
        number.className = 'pool-number';
        if (pool.number === 7) number.classList.add('special');
        number.textContent = pool.number;
        div.appendChild(number);

        const stack = document.createElement('div');
        stack.className = 'token-stack';

        pool.tokens.forEach(t => {
          const tok = document.createElement('div');
          tok.className = 'token';
          tok.style.backgroundColor = players[t.playerIndex].color;
          stack.appendChild(tok);
        });

        div.appendChild(stack);
        board.appendChild(div);
      });
    }

    function renderDice() {
      const container = document.getElementById('dice-container');
      container.innerHTML = '';

      dice.forEach((value, index) => {
        const die = document.createElement('div');
        die.className = 'die';
        if (selectedDice.includes(index)) die.classList.add('selected');
        die.textContent = value;
        die.onclick = () => toggleDie(index);
        container.appendChild(die);
      });

      document.getElementById('doneBtn').disabled = availableMoves.length !== 1 || isAnimating;
      document.getElementById('rollBtn').disabled = dice.length > 0 || isAnimating;
    }

    function toggleDie(index) {
      if (isAnimating) return;

      if (selectedDice.includes(index)) {
        selectedDice = selectedDice.filter(i => i !== index);
      } else {
        selectedDice.push(index);
      }

      highlightSelected();
    }

    function highlightSelected() {
      const sum = selectedDice.reduce((acc, i) => acc + dice[i], 0);
      availableMoves = (sum >= 1 && sum <= 12) ? [sum] : [];
      renderDice();
      renderBoard();
    }

    function renderStatus() {
      const status = document.getElementById('player-status');
      status.innerHTML = '';

      players.forEach((player, idx) => {
        const div = document.createElement('div');
        div.className = 'player-name';
        div.style.color = player.color;
        div.textContent = player.name;

        if (player.wins > 0) {
          const stars = document.createElement('span');
          stars.className = 'stars';
          stars.textContent = '⭐'.repeat(player.wins);
          div.appendChild(stars);
        }

        if (idx === currentPlayerIndex) {
          div.classList.add('active');
          const indicator = document.createElement('span');
          indicator.textContent = ' 👑';
          indicator.style.fontSize = '1.2em';
          div.appendChild(indicator);
        }

        status.appendChild(div);
      });

      const tracker = document.getElementById('token-tracker');
      tracker.innerHTML = '';

      players.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'token-info';
        div.innerHTML = `<div style="margin-bottom: 5px;">${p.name}</div><div style="font-size: 1.1em; color: ${p.color};">${p.tokens} tokens left</div>`;

        const tokenLeft = document.createElement('div');
        tokenLeft.className = 'token-left';

        for (let j = 0; j < p.tokens; j++) {
          const token = document.createElement('span');
          token.className = 'token-count';
          token.style.backgroundColor = p.color;
          tokenLeft.appendChild(token);
        }

        div.appendChild(tokenLeft);
        tracker.appendChild(div);
      });
    }

    function rollDice() {
      if (dice.length > 0 || isAnimating) return;

      dice = [randDie(), randDie(), randDie()];
      selectedDice = [];
      availableMoves = [];
      renderDice();
      renderBoard();
    }

    function randDie() {
      return Math.floor(Math.random() * 6) + 1;
    }

    function confirmChoice() {
      if (availableMoves.length === 1 && !isAnimating) {
        const pool = pools[availableMoves[0] - 1];
        handlePlacement(pool);
      }
    }

    function handlePlacement(pool) {
  const player = players[currentPlayerIndex];
  if (player.tokens <= 0 || isAnimating) return;

  const maxTokens = getMaxTokens(pool.number);

  // Pool 7 has strict limit - no overflow allowed
  if (pool.number === 7 && pool.tokens.length >= 3) {
    alert("Pool 7 is full! You cannot place more tokens there.");
    return;
  }

  isAnimating = true;

  // Handle overflow for pools 1-6 (max 3, overflow allowed) and pools 8-12 (max 2, overflow allowed)
  let pushedOutToken = null;
  if (pool.number >= 1 && pool.number <= 6 && pool.tokens.length >= 3) {
    pushedOutToken = pool.tokens.shift(); // Remove bottom token
    players[pushedOutToken.playerIndex].tokens++; // Return to ORIGINAL OWNER
    
    // Animate the overflow token returning to its owner
    animateOverflowToken(pool, pushedOutToken, () => {
      // After overflow animation, place the new token
      placeNewToken(pool, player);
    });
  } else if (pool.number >= 8 && pool.number <= 12 && pool.tokens.length >= 2) {
    pushedOutToken = pool.tokens.shift(); // Remove bottom token
    players[pushedOutToken.playerIndex].tokens++; // Return to ORIGINAL OWNER
    
    // Animate the overflow token returning to its owner
    animateOverflowToken(pool, pushedOutToken, () => {
      // After overflow animation, place the new token
      placeNewToken(pool, player);
    });
  } else {
    // No overflow, just place the new token
    placeNewToken(pool, player);
  }
}

function animateOverflowToken(pool, pushedOutToken, callback) {
  const ownerIndex = pushedOutToken.playerIndex;
  const ownerColor = players[ownerIndex].color;
  
  // Create flying overflow token
  const overflowToken = document.createElement('div');
  overflowToken.id = 'overflow-token';
  overflowToken.style.position = 'absolute';
  overflowToken.style.width = '28px';
  overflowToken.style.height = '28px';
  overflowToken.style.borderRadius = '50%';
  overflowToken.style.backgroundColor = ownerColor;
  overflowToken.style.border = '3px solid rgba(255,255,255,0.8)';
  overflowToken.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
  overflowToken.style.pointerEvents = 'none';
  overflowToken.style.transition = 'transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), left 0.8s cubic-bezier(0.4, 0, 0.2, 1), top 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
  overflowToken.style.zIndex = '1001';
  
  // Add hippo emoji
  overflowToken.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.5));">🦛</div>';
  
  document.body.appendChild(overflowToken);

  // Start position: bottom of the pool stack
  const poolDiv = document.querySelector(`.pool[data-pool='${pool.number}'] .token-stack`);
  const poolRect = poolDiv.getBoundingClientRect();
  
  overflowToken.style.left = `${poolRect.left + poolDiv.clientWidth / 2 - 14}px`;
  overflowToken.style.top = `${poolRect.bottom - 28}px`;
  overflowToken.style.transform = 'scale(1)';
  overflowToken.style.transition = 'none';

  // End position: owner's token area
  const trackerDivs = document.querySelectorAll('#token-tracker .token-info');
  const ownerTokenArea = trackerDivs[ownerIndex];
  
  let endRect;
  if (ownerTokenArea) {
    endRect = ownerTokenArea.getBoundingClientRect();
  } else {
    // Fallback position
    endRect = { left: 100, top: 100 };
  }

  const finalX = endRect.left + (endRect.width / 2) - 14;
  const finalY = endRect.top + (endRect.height / 2) - 14;

  // Start animation
  requestAnimationFrame(() => {
    overflowToken.style.transition = 
      'transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), left 0.8s cubic-bezier(0.4, 0, 0.2, 1), top 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
    overflowToken.style.left = `${finalX}px`;
    overflowToken.style.top = `${finalY}px`;
    overflowToken.style.transform = 'scale(1.2)';
  });

  overflowToken.addEventListener(
    'transitionend',
    () => {
      overflowToken.remove();
      renderStatus(); // Update the token counts
      callback(); // Proceed with placing new token
    },
    { once: true }
  );
}

function placeNewToken(pool, player) {
  // Add new token on top
  pool.tokens.push({ playerIndex: currentPlayerIndex });
  player.tokens--;

  renderStatus();

  // Animation for placing new token
  const trackerDivs = document.querySelectorAll('#token-tracker .token-info');
  const playerTokenArea = trackerDivs[currentPlayerIndex];

  if (!playerTokenArea) {
    renderBoard();
    finishTurnAfterPlacement(pool);
    return;
  }

  const flyingToken = document.createElement('div');
  flyingToken.id = 'flying-token';
  flyingToken.style.backgroundColor = player.color;
  document.body.appendChild(flyingToken);

  const tokensLeftDiv = playerTokenArea.querySelector('.token-left');
  let startRect;

  if (tokensLeftDiv && tokensLeftDiv.lastChild) {
    startRect = tokensLeftDiv.lastChild.getBoundingClientRect();
  } else {
    startRect = playerTokenArea.getBoundingClientRect();
  }

  flyingToken.style.left = `${startRect.left}px`;
  flyingToken.style.top = `${startRect.top}px`;
  flyingToken.style.transform = 'scale(1)';
  flyingToken.style.transition = 'none';

  const poolDiv = document.querySelector(`.pool[data-pool='${pool.number}'] .token-stack`);
  const tokensInPool = pool.tokens.length;
  const destRect = poolDiv.getBoundingClientRect();
  const offsetY = (tokensInPool - 1) * 34;

  const finalX = destRect.left + poolDiv.clientWidth / 2 - flyingToken.clientWidth / 2;
  const finalY = destRect.top + destRect.height - offsetY - flyingToken.clientHeight - 10;

  requestAnimationFrame(() => {
    flyingToken.style.transition = 
      'transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), left 0.8s cubic-bezier(0.4, 0, 0.2, 1), top 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
    flyingToken.style.left = `${finalX}px`;
    flyingToken.style.top = `${finalY}px`;
    flyingToken.style.transform = 'scale(1)';
  });

  flyingToken.addEventListener(
    'transitionend',
    () => {
      flyingToken.remove();
      renderBoard();
      finishTurnAfterPlacement(pool);
    },
    { once: true }
  );
}

    function finishTurnAfterPlacement(pool) {
      const player = players[currentPlayerIndex];

      if (player.tokens === 0) {
        player.wins++;
        setTimeout(() => alert(`🎉 ${player.name} wins! 🏆`), 100);
        isAnimating = false;
        document.getElementById('rollBtn').disabled = false;
        renderStatus();
        return;
      }

      if (pool.number === 7) {
        alert('🦛 Mr. Hippo! Roll again! 🎲');
        dice = [];
        selectedDice = [];
        availableMoves = [];
        renderDice();
        isAnimating = false;
        document.getElementById('rollBtn').disabled = false;
        rollDice();
        return;
      }

      currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
      dice = [];
      selectedDice = [];
      availableMoves = [];
      renderBoard();
      renderDice();
      renderStatus();
      isAnimating = false;
      document.getElementById('rollBtn').disabled = false;
    }

    function newGame() {
      lastStarterIndex = 1 - lastStarterIndex;
      currentPlayerIndex = lastStarterIndex;
      players.forEach(p => (p.tokens = 8));
      pools.forEach(p => (p.tokens = []));
      dice = [];
      selectedDice = [];
      availableMoves = [];
      isAnimating = false;
      renderBoard();
      renderDice();
      renderStatus();
      document.getElementById('doneBtn').disabled = true;
      document.getElementById('rollBtn').disabled = false;
      updateBackground();
    }

    newGame();
  </script>
</body>
</html>
